<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="js/pixi.min.js"></script>
    <script>
    let app;
    let player;
    let enemy;
    let mouse = {"x": 0, "y": 0};
    let angle; // angle from player to mouse
    let bullets = [];
    let bulletSpeed = 15;

    let keys = {};
    let keysDiv;

    window.onload = function() {
        app = new PIXI.Application(
            // window.innerWidth, 
            // window.innerHeight,
            {
                autoResize: true,
                // resolution: devicePixelRatio,
                width: window.outerWidth,
                height: window.outerHeight,
                backgroundColor: 0xaaaaaa,
            }
        );

        // Listen for window resize events
        window.addEventListener('resize', resize);

        document.body.appendChild(app.view);

        // preload assets
        // app.loader.baseURL = 'images'; // wasnt working would be nice to remove images in all of those below

        app.loader
            .add("player", "images/player3.png")
            .add("bullet", "images/bullet.png");

        // add this to game thread status dict
        app.loader.onProgress.add(showProgress);
        app.loader.onComplete.add(doneLoading); // if loaded, add assets to stage
        app.loader.onError.add(reportError);

        app.loader.load();

        // mouse interaction
        // app.stage.interactive = true;
        // app.stage.on("pointermove", movePlayer);

        //keyboard event handlers
        window.addEventListener("mousemove", mouseMove);
        window.addEventListener("keydown", keyDown);
        window.addEventListener("keyup", keyUp);
        window.addEventListener("pointerdown", pointerDown);

        // game loop
        app.ticker.add(gameLoop);

        // keysDiv = document.querySelector("#keys");
    }

    function resize() {
        app.renderer.resize(window.innerWidth, window.innerHeight);
    }

    function movePlayer(e) {
        let pos = e.data.global;
        player.x = pos.x;
        player.y = pos.y;
    }

    function mouseMove(e) {
        if(e.offsetX) {
            mouse.x = e.offsetX;
            mouse.y = e.offsetY;
        }
        else if(e.layerX) {
            mouse.x = e.layerX;
            mouse.y = e.layerY;
        }

        angle = Math.atan2(mouse.y - player.y, mouse.x - player.x) * 180 / Math.PI;
    }

    function keyDown(e) {
        console.log(e.keyCode);
        keys[e.keyCode] = true;
    }

     function keyUp(e) {
        console.log(e.keyCode);
        keys[e.keyCode] = false;
     }

     function pointerDown(e) {
        console.log("player {" + player.x + "," + player.y + "} " + "fires at {" + mouse.x + "," + mouse.y + "}");

        // check which weapon player has equipped -> got to appropriate action method
        // for now: default gun, bullet
        let bullet = createBullet();
        bullets.push(bullet); 
     }

     function createBullet() {
        let bullet = new PIXI.Sprite(app.loader.resources.bullet.texture);
        bullet.x = player.x + 60; // change to gun.x || arm.x
        bullet.y = player.y + 20;
        app.stage.addChild(bullet);
        return bullet;
     }

     function updateBullets() {
         speed = 15;
        for (let i = 0; i < bullets.length; i++) {
            let bullet = bullets[i];
            bullet.x = bullet.x + Math.cos(angle * Math.PI / 180) * speed;
            bullet.y = bullet.y + Math.sin(angle * Math.PI / 180) * speed;
            if (bullet.y < 0) {
                app.stage.removeChild(bullet);
                bullets.splice(i, 1);
            }
        }
     }

     function gameLoop(delta) {
        //  keysDiv.innerHTML = JSON.stringify(keys);
        updateBullets(delta);
        // D
        if (keys[65]) {
            player.x -= 7;
        }
        // S
        if (keys[87]) {
            player.y -= 7;
        }
        // A
        if (keys[68]) {
            player.x += 7;
        }
        // W
        if (keys[83]) {
            player.y += 7;
        }
     }

     function showProgress(loader, resource) {
        // console.log("loading: " + resource.url);
        console.log("progress: " + loader.progress + "%");
     }

     function doneLoading(loader, resources) {
        console.log("done loading!");

        // player object
        player = new PIXI.Sprite.from(app.loader.resources.player.texture);
        player.anchor.set(0.5);
        player.x = app.view.width / 2;
        player.y = app.view.height / 2;

        app.stage.addChild(player);
     }

     function reportError(loader, resource) {
        console.log("error loading: " + resource.url);
     }

    </script>
</head>
<body>
    <!-- <div id="keys"></div> -->
</body>
</html>