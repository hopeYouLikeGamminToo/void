<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="js/pixi.min.js"></script>
    
    <style>
        @font-face {
            font-family: 'Pixelated';
            src: url('font/arcade-classic.ttf');
        }
        #useFont {
            font-family: 'Pixelated';
            font-size: 0px;
        }
    </style>
    
    <script>
    let app;
    let backdrop;
    let mountainFar;
    let mountainClose;
    let treesFar;
    let treesClose;
    let bgX = 0;
    let bgSpeed = 1;
    let player;
    let playerSheet = {};
    let playerSpeed = 5;
    let enemy;
    let mouse = {"x": 0, "y": 0};
    let angle; // angle from player to mouse
    let bullets = [];
    let bulletSpeed = 15;
    let loopCount = 0;
    let text;
    let keys = {};
    let keysDiv;

    window.onload = function() {
        app = new PIXI.Application(
            // window.innerWidth, 
            // window.innerHeight,
            {
                autoResize: true,
                // resolution: devicePixelRatio,
                width: window.outerWidth, // 800
                height: window.outerHeight, // 600
                backgroundColor: 0xaaaaaa,
            }
        );

        // Listen for window resize events
        window.addEventListener('resize', resize);

        document.body.appendChild(app.view);

        // preload assets
        // app.loader.baseURL = 'assets'; // wasnt working would be nice to remove images in all of those below

        app.loader
            .add('backdrop', 'assets/mountain-dusk-parallax/backdrop.png')
            .add('mountainFar', 'assets/mountain-dusk-parallax/mountains-far.png')
            .add('mountainClose', 'assets/mountain-dusk-parallax/mountains-close.png')
            .add('treesFar', 'assets/mountain-dusk-parallax/trees-far.png')
            .add('treesClose', 'assets/mountain-dusk-parallax/trees-close.png')
            .add("player", "assets/spaceman/original.png")
            .add("enemy", "assets/spaceman/plant-based.png")
            .add("bullet", "assets/bullet.png")
            .add("spaceman", "assets/spaceman/spaceman.png")
            .add("spacemanHead", "assets/spaceman/disassembled/head.png")
            .add("spacemanTorso", "assets/spaceman/disassembled/torso.png")
            .add("spacemanLegs", "assets/spaceman/disassembled/legs.png")
            .add("spacemanArms", "assets/spaceman/disassembled/arms.png")
            .add("spacemanWeapon", "assets/spaceman/disassembled/weapon.png");
        
        // add this to game thread status dict
        app.loader.onProgress.add(showProgress);
        app.loader.onComplete.add(doneLoading); // if loaded, add assets to stage
        app.loader.onError.add(reportError);
        app.loader.load();

        // keysDiv = document.querySelector("#keys");
    }

    function resize() {
        app.renderer.resize(window.innerWidth, window.innerHeight);
    }

    function showProgress(loader, resource) {
        // console.log("loading: " + resource.url);
        console.log("progress: " + loader.progress + "%");
     }

     function doneLoading(loader, resources) {
        console.log("done loading!");

        // create background
        backdrop = createBackground(app.loader.resources["backdrop"].texture);
        mountainsFar = createBackground(app.loader.resources["mountainFar"].texture);
        mountainsClose = createBackground(app.loader.resources["mountainClose"].texture);
        treesFar = createBackground(app.loader.resources["treesFar"].texture);
        treesClose = createBackground(app.loader.resources["treesClose"].texture);

        // player object
        createPlayerSheet();
        createPlayer();
        // player = new PIXI.Sprite.from(app.loader.resources.player.texture);
        // player.anchor.set(0.5);
        // player.x = app.view.width / 2 - 275;
        // player.y = app.view.height / 2 + 275;
        // app.stage.addChild(player);

        // enemy object
        enemy = new PIXI.Sprite.from(app.loader.resources.enemy.texture);
        enemy.anchor.set(0.5);
        enemy.x = app.view.width / 2 + 275;
        enemy.y = app.view.height - 100;
        app.stage.addChild(enemy);

        // mouse interaction
        // app.stage.interactive = true;
        // app.stage.on("pointermove", movePlayer);

        //keyboard event handlers
        window.addEventListener("mousemove", mouseMove);
        window.addEventListener("keydown", keyDown);
        window.addEventListener("keyup", keyUp);
        window.addEventListener("pointerdown", pointerDown);

        text = new PIXI.Text('Welcome   to   the   void!');
        text.x = app.view.width / 2;
        text.y = app.view.height / 2;
        text.anchor.set(0.5);
        text.style = new PIXI.TextStyle(
                {
                fontFamily: 'Pixelated',
                fontSize: '32px',
                fill: '#ffffff',
                align: 'center',
            }
        );
        app.stage.addChild(text);

        // game loop
        app.ticker.add(gameLoop);
     }

     function reportError(loader, resource) {
        console.log("error loading: " + resource.url);
     }

     function createBackground(texture) {
        let tiling = new PIXI.TilingSprite(texture, app.view.width, app.view.height);
        tiling.position.set(0,0);
        app.stage.addChild(tiling);

        return tiling;
     }
     function createPlayerSheet() {
        let w = 122; // fixed
        let h = 165;

        // assembled
        let sheet = new PIXI.BaseTexture.from(app.loader.resources["spaceman"].url);

        playerSheet["standEast"] = [
            // assembled
            new PIXI.Texture(sheet, new PIXI.Rectangle(0, 0, w, h)),

        ]
        playerSheet["walkEast"] = [
            // assembled
            new PIXI.Texture(sheet, new PIXI.Rectangle(0, 0, w, h)),
            new PIXI.Texture(sheet, new PIXI.Rectangle(w, 0, w, h)),
            new PIXI.Texture(sheet, new PIXI.Rectangle(0, h, w, h))
        ]
        
        // playerSheet["walking"]
     }

     function createPlayer() {
        player = new PIXI.AnimatedSprite(playerSheet.standEast);
        player.anchor.set(0.5);
        player.animationSpeed = 0.1;
        player.loop = false;
        player.x = app.view.width / 2 - 275;
        player.y = app.view.height - 80; // / 2 + 275;
        app.stage.addChild(player);
        player.play();
     }

    function movePlayer(e) {
        let pos = e.data.global;
        player.x = pos.x;
        player.y = pos.y;
    }

    function collision(a,b){
        let abox = a.getBounds();
        let bbox = b.getBounds();
        return  abox.x + abox.width > bbox.x && 
                abox.x < bbox.x + bbox.width && 
                abox.y + abox.height > bbox.y && 
                abox.y < bbox.y + bbox.height;
    }

    function mouseMove(e) {
        if(e.offsetX) {
            mouse.x = e.offsetX;
            mouse.y = e.offsetY;
        }
        else if(e.layerX) {
            mouse.x = e.layerX;
            mouse.y = e.layerY;
        }

        angle = Math.atan2(mouse.y - player.y, mouse.x - player.x) * 180 / Math.PI;
    }

    function keyDown(e) {
        console.log(e.keyCode);
        keys[e.keyCode] = true;
    }

     function keyUp(e) {
        console.log(e.keyCode);
        keys[e.keyCode] = false;
     }

     function pointerDown(e) {
        console.log("player {" + player.x + "," + player.y + "} " + "fires at {" + mouse.x + "," + mouse.y + "}");

        // check which weapon player has equipped -> got to appropriate action method
        // for now: default gun, bullet
        let bullet = createBullet();
        bullets.push(bullet); 
     }

     function createBullet() {
        let bullet = new PIXI.Sprite(app.loader.resources.bullet.texture);
        bullet.x = player.x + 60; // change to gun.x || arm.x
        bullet.y = player.y + 20;
        app.stage.addChild(bullet);
        return bullet;
     }

     function updateBullets() {
        let speed = 15;
        for (let i = 0; i < bullets.length; i++) {
            let bullet = bullets[i];
            bullet.x = bullet.x + Math.cos(angle * Math.PI / 180) * speed;
            bullet.y = bullet.y + Math.sin(angle * Math.PI / 180) * speed;
            if (bullet.y < 0) {
                app.stage.removeChild(bullet);
                bullets.splice(i, 1);
            }
        }
     }

     function updateBackground() {
        bgX = (bgX + bgSpeed);
        treesClose.tilePosition.x = bgX/ 6;
        treesFar.tilePosition.x = bgX / 8;
        mountainsClose.tilePosition.x = bgX / 10;
        mountainsFar.tilePosition.x = bgX /12;
        backdrop.tilePosition.x = bgX / 14; 
     }

     function gameLoop(delta) {
        //  keysDiv.innerHTML = JSON.stringify(keys);
        updateBackground();
        updateBullets(delta);
        
        // A
        if (keys[65]) {
            if(!player.playing){
                player.textures = playerSheet.walkEast;
                player.play()
                console.log("player is walking west");
            }
            player.x -= playerSpeed;
        }
        // S
        if (keys[87]) {
            // player.textures = playerSheet.duck;
            player.y -= playerSpeed;
        }
        // A
        if (keys[68]) {
            if(!player.playing){
                player.textures = playerSheet.walkEast;
                player.play()
                console.log("player is walking east");
            }
            player.x += playerSpeed;
        }
        // W
        if (keys[83]) {
            // player.textures = playerSheet.jump;
            player.y += playerSpeed;
        }

        try {
            if (collision(enemy, player)) {
                console.log("collision");
                playerSpeed = 1;
            } else {
                playerSpeed = 5;
            }
        } catch (e) {
            console.log("objects not yet created");
        }

        loopCount++;
        if (loopCount % 60 == 0) {
            console.log("fps: ", app.ticker.FPS);
        }
        if (loopCount % 120 == 0) {
            app.stage.removeChild(text);
        }
     }

    </script>
</head>
<body>
    <!-- <div id="keys"></div> -->
    <div id="useFont">_</div>
</body>
</html>